name: 'PR Analyser'

on:
  pull_request:
    branches:
      - master

jobs:
  terraform:
    name: 'Analyse PR Changes with AI'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Get PR Files
        id: pr_files
        run: |
          PR_FILES=$(curl -s "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            | jq -r '.[].filename' | paste -sd "," -)
          echo "PR_FILES=$PR_FILES" >> $GITHUB_ENV

      - name: Analyze Each File
        env:
          COMMENTS_URL: ${{ github.event.pull_request.comments_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OLLAMA_MODEL: ${{ vars.OLLAMA_MODEL }}
          PR_FILES: ${{ env.PR_FILES }}
        run: |
          echo "Processing files: $PR_FILES"
          IFS=',' read -ra FILES_ARRAY <<< "$PR_FILES"
          for FILE in "${FILES_ARRAY[@]}"; do
            echo "Commiting to $FILE"
          
            # Define the line to comment on (this is just an example, you can adjust it)
            line_number=-1
          
            # GitHub API to create a comment on a specific line in the file
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              -d '{
                    "body": "This is a comment on a specific line in the file: '"$FILE"'",
                    "commit_id": "'${{ github.sha }}'",
                    "path": "'$FILE'",
                    "position": '$line_number'
                  }' \
              "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments"
          done
